<!-- https://www.brycewray.com/posts/2022/06/responsive-optimized-images-hugo/ -->

<!-- todo -->
<!-- commit resources directory? -->

<!-- Test that this all actually works -->
<!-- Can I merge render shortcode and this one? -->
<!-- clean up mediascripts -->
<!-- clean up css -->
<!-- Is quality good enough? -->
<!-- Does zoom work properly? -->

{{ $imageSizes := slice "320" "640" "960" "1280" "1920" }}
{{ $dataSizes := "(max-width: 960), 100% 50%" }}

{{ $quality := 80 }}
{{ if in .Page.Permalink "renders"}}
{{ $quality = 95 }}
{{ end }}

{{- $u := urls.Parse .Destination -}}
{{- $desc := .Text | safeHTML -}}
{{- $title := .Title -}}
{{- $pagePermalink := .Page.Permalink -}}
{{- if not $u.IsAbs -}}
  {{- with or (.Page.Resources.Get $u.Path) (resources.Get $u.Path) -}}
    {{- $png := . -}}
    {{- $webp := .Process "webp q80" -}}
    {{- $jpg := .Process "jpg q90" -}}

<div class="media image" onclick="zoomImage(this)">
  <picture class="fullsize-frame media-frame">
    <source type="image/webp" srcset="
      {{- with $imageSizes -}}
          {{- range $i, $e := . -}}
              {{- if ge $png.Width . -}}
                  {{- if $i }}, {{ end -}}{{- ($png.Resize (printf "%sx%s" . " webp") ).RelPermalink }} {{ . }}w
              {{- end -}}
          {{- end -}}
      {{- end -}}"
      sizes="{{ $dataSizes }}"
  />

    <source type="image/jpg" srcset="
      {{- with $imageSizes -}}
          {{- range $i, $e := . -}}
              {{- if ge $png.Width . -}}
                  {{- if $i }}, {{ end -}}{{- ($png.Resize (printf "%sx%s" . " jpg") ).RelPermalink }} {{ . }}w
              {{- end -}}
          {{- end -}}
      {{- end -}}"
      sizes="{{ $dataSizes }}"
      />

    <img class="image inner" 
        src="{{ $png.Permalink }}"  
        width="{{ .Width }}" 
        height="{{ .Height }}"
        alt='{{ $desc }}' 
        loading="lazy" />
</picture>

  <div class='alt-text-container'>
    {{- if in $pagePermalink "renders" -}}
    <a href='{{ $webp.Permalink }}'>Bigger</a>
    {{- end -}}
    <span class="alt-text">{{ $desc }}</span>
    {{- if in $pagePermalink "renders" -}}
    <a href='{{ $png.Permalink }}'>PNG</a>
    {{- end -}}
  </div>
</div>
  {{- end -}}
{{- else -}}
  <img src="{{ $u.String }}" />
{{- end -}}